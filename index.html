<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DingDingGong Timer</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom animation for message display */
        @keyframes bounce-once {
            0%, 100% {
                transform: translateY(0);
            }
            20%, 80% {
                transform: translateY(-5px);
            }
            40%, 60% {
                transform: translateY(0);
            }
        }
        .animate-bounce-once {
            animation: bounce-once 1s ease-in-out;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 to-purple-600 min-h-screen flex items-center justify-center p-4">
    <div id="root" class="w-full max-w-lg"></div>

    <!-- React and ReactDOM CDNs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX transformation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tone.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Firebase CDNs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase modules and Tone.js globally for the main script
        window.firebaseApp = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged };
        window.firebaseFirestore = { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, query };
        window.Tone = Tone;

        // Firebase configuration and global variables
        // IMPORTANT: Replace these placeholder values with your actual Firebase project configuration.
        // You can find these details in your Firebase project settings (Project settings -> General -> Your apps).
        window.__firebase_config = typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify({
            apiKey: "AIzaSyDBDThGIqFOPoFAzcT0ZatRqgR4rXE8hbM", // Your actual API Key
            authDomain: "dingdinggong-eb4cf.firebaseapp.com",
            projectId: "dingdinggong-eb4cf",
            storageBucket: "dingdinggong-eb4cf.firebasestorage.app",
            messagingSenderId: "447001407729",
            appId: "1:447001407729:web:0742beaf57473789e5b950"
        });
        // Ensure appId defaults for standalone use if not provided by the environment
        window.__app_id = typeof __app_id !== 'undefined' ? __app_id : 'dingdinggong-standalone'; 
        // __initial_auth_token is no longer relevant as we are hardcoding userId
    </script>

    <!-- Your React App code (now processed by Babel) -->
    <script type="text/babel">
        // Access global variables and Firebase/Tone modules
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = window.firebaseApp;
        const { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, query } = window.firebaseFirestore;
        const Tone = window.Tone; // Access Tone.js from global scope

        const firebaseConfig = JSON.parse(window.__firebase_config);
        const appId = window.__app_id;
        // const initialAuthToken = window.__initial_auth_token; // No longer needed

        // Hardcode a user ID for consistent data across devices for a single user
        // IMPORTANT: CHANGE THIS TO A UNIQUE STRING OF YOUR CHOICE!
        const HARDCODED_USER_ID = "8U0I3jg2qxRHzRrJVjoVbgDdAY03"; 

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); // Still need auth object for Firestore rules, even if not signing in

        // Global sound instances
        const dingSynth = new Tone.Synth({
            oscillator: { type: "sine" },
            envelope: {
                attack: 0.05,
                decay: 0.5,
                sustain: 0.05,
                release: 0.5
            }
        }).toDestination();

        const formatTime = (totalSeconds) => {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        };

        const playDing = () => {
            dingSynth.triggerAttackRelease("G6", "0.2s");
        };

        const playTripleDing = () => {
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    playDing();
                }, i * 500);
            }
        };

        const getCirclePoint = (centerX, centerY, radius, angleInDegrees) => {
            const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
            return {
                x: centerX + radius * Math.cos(angleInRadians),
                y: centerY + radius * Math.sin(angleInRadians)
            };
        };

        function App() {
            // userId is now hardcoded, no longer state-driven by auth changes
            const userId = HARDCODED_USER_ID; 
            const [isAuthReady, setIsAuthReady] = React.useState(true); // Set to true as auth state is effectively 'ready' with hardcoded ID
            const [presets, setPresets] = React.useState([]);
            const [selectedPresetId, setSelectedPresetId] = React.useState(null);
            const [timerState, setTimerState] = React.useState('idle');
            const [elapsedTime, setElapsedTime] = React.useState(0);
            const timerRef = React.useRef(null);
            const totalDurationRef = React.useRef(0);
            const [showPresetForm, setShowPresetForm] = React.useState(false);
            const [message, setMessage] = React.useState('');

            const [showConfirmModal, setShowConfirmModal] = React.useState(false);
            const [presetToDelete, setPresetToDelete] = React.useState(null);

            const dingPlayedRef = React.useRef({});

            const setMessageCallback = React.useCallback((msg) => {
                setMessage(msg);
            }, []);

            // Removed authentication useEffect as userId is hardcoded
            // No need for onAuthStateChanged or signInAnonymously calls here.

            React.useEffect(() => {
                // Data fetching now directly uses the hardcoded userId
                if (!userId) return; // Should not happen with hardcoded ID, but good practice

                const presetsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/dingdinggong_presets`);
                const q = query(presetsCollectionRef);

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    let fetchedPresets = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    fetchedPresets.sort((a, b) => a.createdAt - b.createdAt);

                    setPresets(fetchedPresets);

                    if (!selectedPresetId || !fetchedPresets.some(p => p.id === selectedPresetId)) {
                        if (fetchedPresets.length > 0) {
                            setSelectedPresetId(fetchedPresets[0].id);
                        } else {
                            setSelectedPresetId(null);
                        }
                    }
                    setMessageCallback('');
                }, (error) => {
                    console.error("Error fetching presets:", error);
                    setMessageCallback(`Error loading presets: ${error.message}.`);
                });

                return () => unsubscribe();
            }, [userId, selectedPresetId, setMessageCallback]); // Dependencies updated

            const getSelectedPreset = React.useCallback(() => {
                return presets.find(p => p.id === selectedPresetId);
            }, [presets, selectedPresetId]);

            const selectedPreset = getSelectedPreset();

            const { totalDurationOfSelectedPreset, cumulativeIntervalDurations } = React.useMemo(() => {
                if (!selectedPreset) {
                    return { totalDurationOfSelectedPreset: 0, cumulativeIntervalDurations: [] };
                }
                let cumulative = 0;
                const cumulativeDurations = selectedPreset.intervals.map(interval => {
                    cumulative += interval.duration;
                    return cumulative;
                });
                return { totalDurationOfSelectedPreset: cumulative, cumulativeIntervalDurations: cumulativeDurations };
            }, [selectedPreset]);

            React.useEffect(() => {
                totalDurationRef.current = totalDurationOfSelectedPreset;
                setElapsedTime(0);
                setTimerState('idle');
                dingPlayedRef.current = {};
            }, [selectedPresetId, totalDurationOfSelectedPreset]);

            const currentIntervalInfo = React.useMemo(() => {
                if (!selectedPreset || selectedPreset.intervals.length === 0) {
                    return { index: 0, duration: 0, timeElapsedInInterval: 0, totalIntervalCount: 0 };
                }

                let intervalIdx = 0;
                let cumulativeTimeAtStartOfCurrentInterval = 0;

                for (let i = 0; i < selectedPreset.intervals.length; i++) {
                    const intervalDuration = selectedPreset.intervals[i].duration;
                    if (elapsedTime < cumulativeTimeAtStartOfCurrentInterval + intervalDuration) {
                        intervalIdx = i;
                        break;
                    }
                    cumulativeTimeAtStartOfCurrentInterval += intervalDuration;
                    intervalIdx = i;
                }

                if (elapsedTime >= totalDurationOfSelectedPreset && selectedPreset.intervals.length > 0) {
                    intervalIdx = selectedPreset.intervals.length - 1;
                }

                const durationOfCurrentInterval = selectedPreset.intervals[intervalIdx]?.duration || 0;
                const timeElapsedInCurrentInterval = elapsedTime - cumulativeTimeAtStartOfCurrentInterval;

                return {
                    index: intervalIdx,
                    duration: durationOfCurrentInterval,
                    timeElapsedInInterval: timeElapsedInCurrentInterval,
                    totalIntervalCount: selectedPreset.intervals.length
                };
            }, [elapsedTime, selectedPreset, totalDurationOfSelectedPreset]);

            const startTimer = React.useCallback(() => {
                if (timerState === 'running') return;

                if (!selectedPreset || selectedPreset.intervals.length === 0) {
                    setMessageCallback("Please create or select a preset with intervals before starting.");
                    return;
                }

                playDing();

                if (timerState === 'idle' || timerState === 'finished') {
                    setElapsedTime(0);
                    dingPlayedRef.current = {};
                }

                setTimerState('running');
                setMessageCallback('');

                if (timerRef.current) clearInterval(timerRef.current);

                timerRef.current = setInterval(() => {
                    setElapsedTime(prevElapsed => {
                        const nextElapsed = prevElapsed + 1;

                        cumulativeIntervalDurations.forEach((boundary, idx) => {
                            if (nextElapsed === boundary && idx < cumulativeIntervalDurations.length - 1 && !dingPlayedRef.current[boundary]) {
                                playDing();
                                dingPlayedRef.current[boundary] = true;
                            }
                        });

                        if (nextElapsed >= totalDurationRef.current) {
                            clearInterval(timerRef.current);
                            timerRef.current = null;
                            setTimerState('finished');
                            playTripleDing();
                            return totalDurationRef.current;
                        }
                        return nextElapsed;
                    });
                }, 1000);
            }, [timerState, selectedPreset, cumulativeIntervalDurations, totalDurationOfSelectedPreset, setMessageCallback]);

            const pauseTimer = React.useCallback(() => {
                clearInterval(timerRef.current);
                timerRef.current = null;
                setTimerState('paused');
            }, []);

            const resetTimer = React.useCallback(() => {
                clearInterval(timerRef.current);
                timerRef.current = null;
                setTimerState('idle');
                setElapsedTime(0);
                dingPlayedRef.current = {};
            }, []);

            const addPreset = React.useCallback(async (presetData) => {
                // userId is now hardcoded, so it's always "authenticated" for this purpose
                try {
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/dingdinggong_presets`), {
                        ...presetData,
                        createdAt: Date.now()
                    });
                    setMessageCallback("Preset added successfully!");
                    setShowPresetForm(false);
                } catch (e) {
                    console.error("Error adding document: ", e);
                    setMessageCallback(`Error adding preset: ${e.message}`);
                }
            }, [userId, appId, setMessageCallback]);

            const handleDeleteRequest = React.useCallback((id, name) => {
                setPresetToDelete({ id, name });
                setShowConfirmModal(true);
            }, []);

            const confirmDelete = React.useCallback(async () => {
                if (!presetToDelete) { // userId is always available now
                    return;
                }
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/dingdinggong_presets`, presetToDelete.id));
                    setMessageCallback("Preset deleted successfully!");
                    setPresetToDelete(null);
                    setShowConfirmModal(false);
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    setMessageCallback(`Error deleting preset: ${e.message}`);
                }
            }, [userId, appId, presetToDelete, setMessageCallback]);

            const cancelDelete = React.useCallback(() => {
                setPresetToDelete(null);
                setShowConfirmModal(false);
            }, []);

            const radius = 45;
            const circumference = 2 * Math.PI * radius;
            const strokeWidth = 8;
            const centerX = 50;
            const centerY = 50;

            const progressPercentage = totalDurationOfSelectedPreset > 0
                ? (elapsedTime / totalDurationOfSelectedPreset) * 100
                : 0;

            const progressOffset = circumference - (progressPercentage / 100) * circumference;

            const intervalMarkerPoints = React.useMemo(() => {
                const points = [];
                let cumulativeAngle = 0;
                if (selectedPreset && totalDurationOfSelectedPreset > 0) {
                    selectedPreset.intervals.forEach((interval, index) => {
                        const intervalAngle = (interval.duration / totalDurationOfSelectedPreset) * 360;
                        cumulativeAngle += intervalAngle;
                        if (index < selectedPreset.intervals.length - 1) {
                            const markerPoint = getCirclePoint(centerX, centerY, radius, cumulativeAngle);
                            points.push(markerPoint);
                        }
                    });
                }
                return points;
            }, [selectedPreset, totalDurationOfSelectedPreset]);

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-500 to-purple-600 p-4 text-gray-100 font-sans flex flex-col items-center">
                    <h1 className="text-4xl md:text-5xl font-extrabold mb-8 text-center drop-shadow-lg">
                        DingDingGong Timer
                    </h1>

                    {/* Display the hardcoded User ID */}
                    <div className="mb-4 text-sm text-center bg-purple-700 bg-opacity-70 rounded-full px-4 py-2 shadow-md">
                        <span className="font-semibold">Your User ID:</span> {userId}
                    </div>

                    {message && (
                        <div className="bg-yellow-400 text-gray-900 font-bold px-4 py-3 rounded-lg mb-4 text-center shadow-lg animate-bounce-once">
                            {message}
                        </div>
                    )}

                    <div className="w-full max-w-lg bg-gray-800 bg-opacity-70 rounded-xl p-6 mb-8 shadow-2xl backdrop-blur-sm border border-purple-700 flex flex-col items-center justify-center">
                        <h2 className="text-2xl font-bold mb-4 text-center text-purple-200">
                            {selectedPreset ? selectedPreset.name : "No Preset Selected"}
                        </h2>

                        <div className="relative w-48 h-48 flex items-center justify-center mb-6">
                            <svg className="absolute w-full h-full" viewBox="0 0 100 100">
                                <circle
                                    cx={centerX}
                                    cy={centerY}
                                    r={radius}
                                    fill="none"
                                    stroke="#4B5563"
                                    strokeWidth={strokeWidth}
                                />
                                <circle
                                    cx={centerX}
                                    cy={centerY}
                                    r={radius}
                                    fill="none"
                                    stroke="#10B981"
                                    strokeWidth={strokeWidth}
                                    strokeDasharray={circumference}
                                    strokeDashoffset={progressOffset}
                                    transform="rotate(-90 50 50)"
                                    className="transition-all duration-1000 ease-linear"
                                />
                                {intervalMarkerPoints.map((point, index) => (
                                    <circle
                                        key={`marker-${index}`}
                                        cx={point.x}
                                        cy={point.y}
                                        r="3"
                                        fill="#FFFFFF"
                                        stroke="#4B5563"
                                        strokeWidth="1"
                                    />
                                ))}
                            </svg>
                            <div className="absolute text-center">
                                <div className="text-5xl md:text-6xl font-mono text-green-400 drop-shadow-md">
                                    {formatTime(elapsedTime)}
                                </div>
                                <div className="text-lg text-purple-300 mt-2">
                                    Interval {currentIntervalInfo.index + 1} of {currentIntervalInfo.totalIntervalCount}
                                </div>
                            </div>
                        </div>
                        
                        <div className="flex justify-center space-x-4">
                            {timerState !== 'running' && timerState !== 'finished' && (
                                <button
                                    onClick={startTimer}
                                    className="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 active:scale-95 flex items-center"
                                >
                                    <svg className="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.025A1 1 0 0111 8v4a1 1 0 01-1.555.975l-3.5-2a1 1 0 010-1.95l3.5-2z" clipRule="evenodd"></path></svg>
                                    Start
                                </button>
                            )}
                            {timerState === 'running' && (
                                <button
                                    onClick={pauseTimer}
                                    className="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 active:scale-95 flex items-center"
                                >
                                    <svg className="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 011-1h.5a1 1 0 011 1v4a1 1 0 01-1 1H8a1 1 0 01-1-1V8zm5 0a1 1 0 011-1h.5a1 1 0 011 1v4a1 1 0 01-1 1H13a1 1 0 01-1-1V8z" clipRule="evenodd"></path></svg>
                                    Pause
                                </button>
                            )}
                            {(timerState === 'paused' || timerState === 'finished' || elapsedTime > 0) && (
                                <button
                                    onClick={resetTimer}
                                    className="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 active:scale-95 flex items-center"
                                >
                                    <svg className="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M8.528 2.012a.5.5 0 01.442.028l7.5 4.5a.5.5 0 010 .86l-7.5 4.5A.5.5 0 018 11.5v-3.86l-2.024 1.488a.5.5 0 01-.588-.024l-3.5-2A.5.5 0 011 6.5v-3a.5.5 0 01.5-.5H3a.5.5 0 01.5.5v2.236L7.5 2.012zM12 18a8 8 0 100-16 8 8 0 000 16zM11 5a1 1 0 011-1h.5a1 1 0 011 1v4a1 1 0 01-1 1H12a1 1 0 01-1-1V5z" clipRule="evenodd"></path></svg>
                                    Reset
                                </button>
                            )}
                        </div>
                    </div>

                    <div className="w-full max-w-lg bg-gray-800 bg-opacity-70 rounded-xl p-6 shadow-2xl backdrop-blur-sm border border-purple-700">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-bold text-purple-200">Your Presets</h2>
                            <button
                                onClick={() => setShowPresetForm(!showPresetForm)}
                                className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 active:scale-95 flex items-center"
                            >
                                <svg className="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clipRule="evenodd"></path></svg>
                                {showPresetForm ? 'Cancel Add' : 'New Preset'}
                            </button>
                        </div>

                        {showPresetForm && (
                            <PresetForm
                                addPreset={addPreset}
                                onCancel={() => setShowPresetForm(false)}
                                setMessage={setMessageCallback}
                            />
                        )}

                        <div className="mt-4 space-y-3">
                            {presets.length === 0 ? (
                                <p className="text-center text-gray-400">No presets saved yet. Create one!</p>
                            ) : (
                                presets.map((preset) => (
                                    <div
                                        key={preset.id}
                                        className={`flex items-center justify-between p-4 rounded-lg shadow-md cursor-pointer transition-all duration-200
                                            ${selectedPresetId === preset.id ? 'bg-purple-700 border-2 border-green-400' : 'bg-gray-700 hover:bg-gray-600'}`}
                                        onClick={() => setSelectedPresetId(preset.id)}
                                    >
                                        <span className="font-semibold text-lg">{preset.name}</span>
                                        <div className="flex items-center space-x-2">
                                            <span className="text-sm text-gray-300">
                                                {preset.intervals.length} intervals, Total: {formatTime(preset.intervals.reduce((sum, int) => sum + int.duration, 0))}
                                            </span>
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    handleDeleteRequest(preset.id, preset.name);
                                                }}
                                                className="bg-red-600 hover:bg-red-700 text-white p-2 rounded-full shadow-sm transition-all duration-300 transform hover:scale-110 active:scale-90"
                                                title="Delete Preset"
                                            >
                                                <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm3 3a1 1 0 011-1h1a1 1 0 110 2h-1a1 1 0 01-1-1z" clipRule="evenodd"></path></svg>
                                            </button>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>

                    {showConfirmModal && presetToDelete && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-gray-800 p-6 rounded-lg shadow-xl text-center border border-purple-700">
                                <p className="text-xl font-semibold mb-4 text-purple-200">Confirm Deletion</p>
                                <p className="mb-6 text-gray-100">Are you sure you want to delete preset "<span className="font-bold text-red-400">{presetToDelete.name}</span>"?</p>
                                <div className="flex justify-center space-x-4">
                                    <button
                                        onClick={confirmDelete}
                                        className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 active:scale-95"
                                    >
                                        Delete
                                    </button>
                                    <button
                                        onClick={cancelDelete}
                                        className="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-5 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 active:scale-95"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function PresetForm({ addPreset, onCancel, setMessage }) {
            const [presetName, setPresetName] = React.useState('');
            const [intervals, setIntervals] = React.useState([]);
            const [currentIntervalDurationMinutes, setCurrentIntervalDurationMinutes] = React.useState(1);

            const totalDuration = intervals.reduce((sum, interval) => sum + interval.duration, 0);
            const totalIntervalCount = intervals.length;

            const handleAddInterval = () => {
                const durationMinutes = parseFloat(currentIntervalDurationMinutes);
                if (isNaN(durationMinutes) || durationMinutes <= 0) {
                    setMessage("Please enter a valid positive duration for the interval.");
                    return;
                }
                const durationSeconds = Math.round(durationMinutes * 60); 
                setIntervals(prev => [...prev, { duration: durationSeconds }]);
                setCurrentIntervalDurationMinutes(durationMinutes);
                setMessage('');
            };

            const handleRemoveInterval = (indexToRemove) => {
                setIntervals(prev => prev.filter((_, index) => index !== indexToRemove));
            };

            const handleSavePreset = (e) => {
                e.preventDefault();
                if (!presetName.trim()) {
                    setMessage("Preset name cannot be empty.");
                    return;
                }
                if (intervals.length === 0) {
                    setMessage("Please add at least one interval to your preset.");
                    return;
                }
                addPreset({ name: presetName.trim(), intervals });
                setPresetName('');
                setIntervals([]);
                setCurrentIntervalDurationMinutes(1);
            };

            return (
                <form onSubmit={handleSavePreset} className="bg-gray-700 p-5 rounded-lg shadow-inner mb-6 border border-gray-600">
                    <h3 className="text-xl font-bold mb-4 text-purple-300">Create New Preset</h3>
                    <div className="mb-4">
                        <label htmlFor="presetName" className="block text-gray-200 text-sm font-bold mb-2">Preset Name</label>
                        <input
                            type="text"
                            id="presetName"
                            value={presetName}
                            onChange={(e) => setPresetName(e.target.value)}
                            className="shadow appearance-none border border-gray-600 rounded-lg w-full py-2 px-3 text-gray-900 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 bg-gray-300"
                            placeholder="e.g., Study Session, Yoga Flow, HIIT"
                            required
                        />
                    </div>

                    <div className="mb-4">
                        <label htmlFor="intervalDuration" className="block text-gray-200 text-sm font-bold mb-2">Interval Duration (minutes)</label>
                        <div className="flex space-x-2">
                            <input
                                type="number"
                                id="intervalDuration"
                                value={currentIntervalDurationMinutes}
                                onChange={(e) => setCurrentIntervalDurationMinutes(e.target.value)}
                                className="shadow appearance-none border border-gray-600 rounded-lg w-full py-2 px-3 text-gray-900 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 bg-gray-300"
                                min="0.1"
                                step="0.1"
                                required
                            />
                            <button
                                type="button"
                                onClick={handleAddInterval}
                                className="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 active:scale-95 flex-shrink-0"
                            >
                                Add Interval
                            </button>
                        </div>
                    </div>

                    {intervals.length > 0 && (
                        <div className="mb-4 bg-gray-600 p-4 rounded-lg border border-gray-500">
                            <h4 className="text-md font-semibold text-gray-100 mb-2">Current Intervals:</h4>
                            <ul className="list-disc list-inside space-y-1 text-gray-200">
                                {intervals.map((interval, index) => (
                                    <li key={index} className="flex justify-between items-center text-sm">
                                        <span>Interval {index + 1}: {interval.duration} seconds</span>
                                        <button
                                            type="button"
                                            onClick={() => handleRemoveInterval(index)}
                                            className="text-red-400 hover:text-red-500 p-1 rounded-full transition-colors duration-200"
                                            title="Remove Interval"
                                        >
                                            <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm3 3a1 1 0 011-1h1a1 1 0 110 2h-1a1 1 0 01-1-1z" clipRule="evenodd"></path></svg>
                                            </button>
                                    </li>
                                ))}
                            </ul>
                            <div className="mt-3 pt-3 border-t border-gray-500 text-md font-semibold text-yellow-300">
                                Total Intervals: {totalIntervalCount}, Total Duration: {formatTime(totalDuration)}
                            </div>
                        </div>
                    )}

                    <div className="flex justify-end space-x-3">
                        <button
                            type="button"
                            onClick={onCancel}
                            className="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 active:scale-95"
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 active:scale-95"
                        >
                            Save Preset
                        </button>
                    </div>
                </form>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
    </script>
</body>
</html>
